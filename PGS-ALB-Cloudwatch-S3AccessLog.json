{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template for creating an Application Load Balancer (ALB) with CloudWatch Alarms and Access Logs.",
  "Parameters": {
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "ID of the VPC where the ALB will be deployed."
    }
  },
  "Resources": {
    "LoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Name": "MyLoadBalancer",
        "Scheme": "internet-facing",
        "Subnets": [
          { "Ref": "PublicSubnet1" },
          { "Ref": "PublicSubnet2" }
        ],
        "SecurityGroups": [ { "Ref": "LoadBalancerSecurityGroup" } ],
        "Type": "application"
      }
    },
    "TargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": "MyTargetGroup",
        "Protocol": "HTTP",
        "Port": 80,
        "VpcId": { "Ref": "VpcId" }
      }
    },
    "Listener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": { "Ref": "LoadBalancer" },
        "Protocol": "HTTP",
        "Port": 80,
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": { "Ref": "TargetGroup" }
          }
        ]
      }
    },
    "CloudWatchAlarmHighRequestCount": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": "ALBHighRequestCountAlarm",
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "EvaluationPeriods": 1,
        "MetricName": "RequestCount",
        "Namespace": "AWS/ApplicationELB",
        "Period": 60,
        "Statistic": "Sum",
        "Threshold": 1000,
        "AlarmDescription": "Alarm if the ALB request count is high.",
        "AlarmActions": [ { "Ref": "SnsTopic" } ]
      }
    },
    "ALBAccessLogsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "alb-access-logs-${AWS::AccountId}" },
        "AccessControl": "LogDeliveryWrite",
        "VersioningConfiguration": { "Status": "Enabled" }
      }
    },
    "ALBLogging": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "LoadBalancerArn": { "Ref": "LoadBalancer" },
        "AccessLogs": {
          "S3Bucket": { "Ref": "ALBAccessLogsBucket" },
          "Enabled": true
        }
      }
    },
    "SnsTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "DisplayName": "ALBHighRequestCountTopic"
      }
    }
  },
  "Outputs": {
    "LoadBalancerDNSName": {
      "Description": "DNS name of the Application Load Balancer.",
      "Value": { "Fn::GetAtt": [ "LoadBalancer", "DNSName" ] }
    },
    "SnsTopicArn": {
      "Description": "ARN of the SNS topic for ALB high request count alarms.",
      "Value": { "Ref": "SnsTopic" }
    }
  }
}
