description: This SSM document is to attach a single security group to EC2 instances with a specific tag.
schemaVersion: '0.3'
assumeRole: 'arn:aws:iam::{{global:ACCOUNT_ID}}:role/sea-pfg-ssm-custom-role'
parameters:
  SecurityGroupName:
    type: String
    description: Name of the existing security group to attach.
  TagName:
    type: String
    default: SecurityGroup
    description: Tag name to filter instances.
  TagValue:
    type: String
    default: pfg-network-sg
    description: Tag value to filter instances.
mainSteps:
  - name: GetEC2InstancesWithTag
    action: 'aws:executeAwsApi'
    inputs:
      Service: ec2
      Api: DescribeInstances
      Filters:
        - Name: tag:{{TagName}}
          Values:
            - '{{TagValue}}'
    outputs:
      - Name: InstanceIds
        Selector: $.Reservations[*].Instances[*].InstanceId
        Type: StringList
  - name: AttachSecurityGroupToInstances
    action: 'aws:executeAwsApi'
    inputs:
      Api: ModifyInstanceAttribute
      Service: ec2
      InstanceIds: '{{GetEC2InstancesWithTag.InstanceIds}}'
      Groups:
        - '{{SecurityGroupName}}'
