description: This SSM document is to add a single existing security group to EC2 instances tagged with a specific tag.
schemaVersion: '0.3'
assumeRole: 'arn:aws:iam::{{global:ACCOUNT_ID}}:role/sea-pfg-ssm-custom-role'
mainSteps:
  - name: FindInstancesWithTag
    action: 'aws:executeAwsApi'
    inputs:
      Service: ec2
      Api: DescribeInstances
      Filters:
        - Name: tag:{{TagKey}}
          Values:
            - '{{TagValue}}'
    outputs:
      - Name: InstanceInfo
        Selector: '$.Reservations[].Instances[].InstanceId'
        Type: StringList
  - name: ExtractInstanceIds
    action: 'aws:runShellScript'
    inputs:
      runCommand:
        - 'echo "{{InstanceInfo}}" | tr -d ''[]"'' | tr ''','' ''\n'''
  - name: AttachSGToInstances
    action: 'aws:executeAwsApi'
    inputs:
      Api: ModifyInstanceAttribute
      Service: ec2
      InstanceId: '{{ExtractInstanceIds.stdout}}'
      Groups:
        - '{{SGID}}'
