description: This SSM document is to add a single existing security group to EC2 instances tagged with a specific tag.
schemaVersion: '2.2'
assumeRole: 'arn:aws:iam::{{global:ACCOUNT_ID}}:role/sea-pfg-ssm-custom-role'
mainSteps:
  - name: FindInstancesWithTag
    action: 'aws:executeAwsApi'
    inputs:
      Service: ec2
      Api: DescribeInstances
      Filters:
        - Name: tag:{{TagKey}}
          Values:
            - '{{TagValue}}'
  - name: ExtractInstanceIds
    action: 'aws:runShellScript'
    inputs:
      runCommand:
        - 'aws ec2 describe-instances --query "Reservations[].Instances[].InstanceId" --output text --filters "Name=tag:{{TagKey}},Values={{TagValue}}" | tr ''\n'' '','''
  - name: AttachSGToInstances
    action: 'aws:executeAwsApi'
    inputs:
      Api: ModifyInstanceAttribute
      Service: ec2
      InstanceId: '{{ExtractInstanceIds.stdout}}'
      Groups:
        - '{{SGID}}'
