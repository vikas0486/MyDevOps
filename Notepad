{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Create an Application Load Balancer (ALB) with CloudWatch alarms and access logs.",
    "assumeRole": "{{ AutomationAssumeRole }}",
    "parameters": {
        "SecurityGroupId": {
          "type": "String",
          "description": "(Required) The ID of the security group (SG) that you are updating, in the form sg-0123456789abcdef.",
          "allowedPattern": "^sg-[0-9a-f]{8}$|^sg-[0-9a-f]{17}$"
        },
        "PublicSubnetId1": {
            "type": "String",
            "description": "(Required) The ID of the subnet that you are updating, in the form subnet-080ee376aefdece8e.",
            "allowedPattern": "^subnet-[0-9a-f]{8}$|^sg-[0-9a-f]{17}$"
          },
          "PublicSubnetId2": {
            "type": "String",
            "description": "(Required) The ID of the subnet that you are updating, in the form subnet-0495069861a96f48f.",
            "allowedPattern": "^subnet-[0-9a-f]{8}$|^sg-[0-9a-f]{17}$"
          },
          "VpcId": {
            "type": "String",
            "description": "(Required) The ID of the vpc that you are updating, in the form vpc-048e218b7ea9246f9.",
            "allowedPattern": "^vpc-[0-9a-f]{8}$|^vpc-[0-9a-f]{17}$"
          },
          "AutomationAssumeRole": {
            "type": "String",
            "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
            "allowedPattern": "^arn:(aws|aws-cn|aws-us-gov):iam::[0-9]{12}:role/[A-Za-z0-9_-]+$"
          },
          "AWSALBAccountId": {
            "type": "Number",
            "description": "(Required) The AWS account ID to allow access to putting logs in this bucket, in the form 127311923021.",
            "allowedPattern": "^[0-9]{12}$",
            "default": "127311923021"
            "Metadata" : {

                "Comment" : "AWS account for Elastic Load Balancing for your Region:

                US East (N. Virginia)       127311923021
                US East (Ohio)              033677994240
                US West (N. California)     027434742980
                US West (Oregon)            797873946194
                Africa (Cape Town)          098369216593
                Asia Pacific (Hong Kong)    754344448648
                Asia Pacific (Jakarta)      589379963580
                Asia Pacific (Mumbai)       718504428378
                Asia Pacific (Osaka)        383597477331
                Asia Pacific (Seoul)        600734575887
                Asia Pacific (Singapore)    114774131450
                Asia Pacific (Sydney)       78322531926
                Asia Pacific (Tokyo)        582318560864               
                Canada (Central)            985666609251               
                Europe (Frankfurt)          054676820928               
                Europe (Ireland)            156460612806               
                Europe (London)             652711504416               
                Europe (Milan)              635631232127               
                Europe (Paris)              009996457667               
                Europe (Stockholm)          897822967062
                Middle East (Bahrain)       076674570225
                South America (SÃ£o Paulo)   507241528517
                AWS GovCloud (US-West)      048591011584
                AWS GovCloud (US-East)      190560391635
                ",  
    
                "Version" : "1.2.1_1"
                }
          }

    },  
    "Resources": {
      "AccessLogBucket": {
        "Type": "AWS::S3::Bucket",
        "Properties": {
          "BucketName": "pgs-alb-accesslog-s3bucket",
          "LifecycleConfiguration": {
            "Rules": [
              {
                "Id": "ExpireLogs",
                "ExpirationInDays": 365,
                "Status": "Enabled"
              }
            ]
          },
          "PublicAccessBlockConfiguration": {
            "BlockPublicAcls": true,
            "BlockPublicPolicy": true,
            "IgnorePublicAcls": true,
            "RestrictPublicBuckets": true
          }
        },
        "DeletionPolicy": "Retain"
      },
      "ALBLoggingBucketPolicy": {
        "Type": "AWS::S3::BucketPolicy",
        "Properties": {
          "Bucket": {
            "Ref": "AccessLogBucket"
          },
          "PolicyDocument": {
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "AWS": "{{ AWSALBAccountId }}" 
                },
                "Action": "s3:PutObject",
                "Resource": {
                  "Fn::Sub": "arn:aws:s3:::${AccessLogBucket}/*"
                }
              }
            ]
          }
        }
      },
      "LoadBalancer": {
        "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
        "Properties": {
          "Name": "PGS-LoadBalancer",
          "Scheme": "internet-facing",
          "Type": "application",
          "IpAddressType": "ipv4",
          "Subnets": [
            "{{ PublicSubnetId1 }}",
            "{{ PublicSubnetId2 }}"
          ],
          "SecurityGroups": ["{{ SecurityGroupId }}"],
          "Tags": [
            {
              "Key": "Name",
              "Value": "PGS-CF-SSM-ALB"
            }
          ],
          "LoadBalancerAttributes": [
            {
              "Key": "access_logs.s3.enabled",
              "Value": "true"
            },
            {
              "Key": "access_logs.s3.bucket",
              "Value": {
                "Ref": "AccessLogBucket"
              }
            }
          ]
        }
      },
      "TargetGroup": {
        "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
        "Properties": {
          "Name": "PGS-TargetGroup",
          "Port": 80,
          "Protocol": "HTTP",
          "VpcId": "{{ SecurityGroupId }}",
          "HealthCheckProtocol": "HTTP",
          "HealthCheckPath": "/",
          "HealthCheckIntervalSeconds": 30,
          "HealthCheckTimeoutSeconds": 10,
          "HealthyThresholdCount": 3,
          "UnhealthyThresholdCount": 3,
          "Tags": [
            {
              "Key": "Name",
              "Value": "PGS-CF-SSM-TG"
            }
          ]
        }
      },
      "Listener": {
        "Type": "AWS::ElasticLoadBalancingV2::Listener",
        "Properties": {
          "LoadBalancerArn": {
            "Ref": "LoadBalancer"
          },
          "Port": 80,
          "Protocol": "HTTP",
          "DefaultActions": [
            {
              "Type": "forward",
              "TargetGroupArn": {
                "Ref": "TargetGroup"
              }
            }
          ]
        }
      },
      "CloudWatchAlarm": {
        "Type": "AWS::CloudWatch::Alarm",
        "Properties": {
          "AlarmName": "PGS-High-ALB-Requests",
          "ComparisonOperator": "GreaterThanThreshold",
          "EvaluationPeriods": 1,
          "MetricName": "RequestCount",
          "Namespace": "AWS/ApplicationELB",
          "Period": 60,
          "Statistic": "SampleCount",
          "Threshold": 1000,
          "AlarmDescription": "Alarm if ALB requests exceed 1000 per minute",
          "AlarmActions": [],
          "Dimensions": [
            {
              "Name": "LoadBalancer",
              "Value": {
                "Ref": "LoadBalancer"
              }
            }
          ]
        }
      }
    }
  }
