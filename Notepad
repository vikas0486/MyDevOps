description: Create Security Group with Inbound and Outbound Rules
schemaVersion: '0.3'
parameters:
  VPCID:
    type: 'String'
    description: Enter the VPC ID where the security group will be created.
  SecurityGroupName:
    type: 'String'
    description: Enter the name for the new security group.
  InboundCIDR1:
    type: 'String'
    description: Enter the CIDR for Inbound Rule 1 (e.g., 0.0.0.0/0).
    default: ''
  FromPort1:
    type: 'String'
    description: Enter the From Port for Inbound Rule 1.
    default: ''
  ToPort1:
    type: 'String'
    description: Enter the To Port for Inbound Rule 1.
    default: ''
  InboundProtocol1:
    type: 'String'
    description: Enter the protocol for Inbound Rule 1 (e.g., tcp, udp, icmp).
    default: ''
  OutboundCIDR:
    type: 'String'
    description: Enter the outbound CIDR block (e.g., 0.0.0.0/0).
    default: ''
  OutboundPorts:
    type: 'String'
    description: Enter the range of ports for outbound rules (e.g., 80,443).
    default: ''
  OutboundProtocol:
    type: 'String'
    description: Enter the protocol for outbound rules (e.g., tcp, udp, icmp).
    default: ''

mainSteps:
  - name: CreateSecurityGroup
    action: 'aws:executeAwsApi'
    inputs:
      Service: ec2
      Api: CreateSecurityGroup
      VpcId: '{{VPCID}}'
      GroupName: '{{SecurityGroupName}}'
      Description: 'Created by SSM Automation'
    outputs:
      - Name: SecurityGroupId
        Selector: '$.GroupId'
        Type: String

  - name: ConfigureInboundRules
    action: 'aws:executeAwsApi'
    when: '{{InboundCIDR1}} != ""'
    inputs:
      Service: ec2
      Api: AuthorizeSecurityGroupIngress
      GroupId: '{{CreateSecurityGroup.SecurityGroupId}}'
      IpPermissions:
        - FromPort: '{{FromPort1}}'
          ToPort: '{{ToPort1}}'
          IpProtocol: '{{InboundProtocol1}}'
          IpRanges:
            - CidrIp: '{{InboundCIDR1}}'

  - name: ConfigureOutboundRule
    action: 'aws:executeAwsApi'
    when: '{{OutboundCIDR}} != ""'
    inputs:
      Service: ec2
      Api: AuthorizeSecurityGroupEgress
      GroupId: '{{CreateSecurityGroup.SecurityGroupId}}'
      IpPermissions:
        - FromPort: '{{OutboundPorts}}'
          ToPort: '{{OutboundPorts}}'
          IpProtocol: '{{OutboundProtocol}}'
          IpRanges:
            - CidrIp: '{{OutboundCIDR}}'
