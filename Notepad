Description: This stack creates IAM role for the codebuild project
Resources:
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "AWSManagedServices-codebuild-service-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: ['sts:AssumeRole']
            Effect: Allow
            Principal:
              Service: ['codebuild.amazonaws.com']
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS: "347091590647"
      Policies:
        - PolicyName: "AWSManagedServices-cdk-codebuild-service-policy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action: # Allow to push logs to cloudwatch
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Effect: Allow
                Resource: "*"
              - Action:
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:DeleteChangeSet'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:ExecuteChangeSet'
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:UpdateStack'
                Resource: '*'
                Effect: Allow
                Sid: CloudFormationPermissions
              - Action:
                  - 's3:GetObject*'
                  - 's3:GetBucket*'
                  - 's3:List*'
                  - 's3:Abort*'
                  - 's3:DeleteObject*'
                  - 's3:PutObject*'
                  - 's3:GetBucketAcl'
                  - 's3:GetBucketLocation'
                Resource: '*'
                Effect: Allow
                Sid: PipelineCrossAccountArtifactsBucket
              - Condition:
                  StringEquals:
                    'kms:ViaService': s3.ap-southeast-1.amazonaws.com
                Action:
                  - 'kms:Decrypt'
                  - 'kms:DescribeKey'
                  - 'kms:Encrypt'
                  - 'kms:ReEncrypt*'
                  - 'kms:GenerateDataKey*'
                Resource: '*'
                Effect: Allow
                Sid: PipelineCrossAccountArtifactsKey
              - Sid: ConfluentPolicy
                Effect: Allow
                Action:
                  - 'cloudformation:Describe*'
                  - 'ssm:GetParameter'
                  - 'ssm:GetParameters'
                  - 'sts:*'
                Resource: '*'
