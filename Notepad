{
  "schemaVersion": "2.2",
  "description": "Attach a security group to instances",
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "attachSecurityGroup",
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "VPC_ID=\"{{VPC_ID}}\"",
          "SECURITY_GROUP_NAME=\"{{SECURITY_GROUP_NAME}}\"",
          "INBOUND_CIDR1=\"{{INBOUND_CIDR1}}\"",
          "INBOUND_CIDR2=\"{{INBOUND_CIDR2}}\"",
          "FROM_PORT=\"{{FROM_PORT}}\"",
          "TO_PORT=\"{{TO_PORT}}\"",
          "OUTBOUND_CIDR1=\"{{OUTBOUND_CIDR1}}\"",
          "OUTBOUND_PORTS=\"{{OUTBOUND_PORTS}}\"",
          "INSTANCE_IDS=\"{{INSTANCE_IDS}}\"",
          "for instance_id in $INSTANCE_IDS; do",
          "  aws ec2 authorize-security-group-ingress --group-name $SECURITY_GROUP_NAME --protocol tcp --port-range $FROM_PORT-$TO_PORT --source $INBOUND_CIDR1",
          "  aws ec2 authorize-security-group-ingress --group-name $SECURITY_GROUP_NAME --protocol tcp --port-range $FROM_PORT-$TO_PORT --source $INBOUND_CIDR2",
          "  aws ec2 authorize-security-group-egress --group-name $SECURITY_GROUP_NAME --protocol tcp --port-range $OUTBOUND_PORTS --destination $OUTBOUND_CIDR1",
          "  aws ec2 modify-instance-attribute --instance-id $instance_id --groups $SECURITY_GROUP_NAME",
          "done"
        ]
      }
    }
  ]
}
